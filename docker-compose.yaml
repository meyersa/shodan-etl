services:
  # <-- Kafka --> #
  zookeeper:
    image: confluentinc/cp-zookeeper
    profiles: [ kafka, all ]
    container_name: zookeeper
    ports:
      - "2181:2181"
    env_file:
      - .env

  kafka:
    image: confluentinc/cp-kafka
    profiles: [ kafka, all ] 
    container_name: kafka
    ports:
      - "9092:9092"
      - "29092:29092"
    env_file:
      - .env
    # depends_on:
    #   - zookeeper
  # <-- End Kafka --> #

  # <-- Producers --> #
  shodan-asn-producer:
    image: python-runner
    profiles: [ not-kafka, producer, all ]
    container_name: shodan_asn_producer
    build:
      context: ./
    environment:
      - SCRIPT=shodan_asn_producer
    env_file:
      - .env
    # depends_on:
    #   - kafka

  shodan-name-producer:
    image: python-runner
    profiles: [ not-kafka, producer, all ]
    container_name: shodan_name_producer
    environment:
      - SCRIPT=shodan_name_producer
    env_file:
      - .env
    # depends_on:
    #   - kafka
  # <-- End Producers --> #

  # <-- Transformation --> #
  transformation:
    image: python-runner
    profiles: [ not-kafka, transform, all ]
    container_name: transformation
    environment:
      - SCRIPT=transformation
    env_file:
      - .env
    # depends_on:
    #   - kafka
  # <-- End Transformation --> # 

  # <-- Enrichment --> #
  api-enrich:
    image: python-runner
    profiles: [ not-kafka, transform, all ]
    container_name: api_enrich
    environment:
      - SCRIPT=api_enrich
    env_file:
      - .env

  maxmind-enrich: 
    image: observabilitystack/geoip-api
    profiles: [ not-kafka, enrich, all]
    container_name: maxmind_enrich
    volumes:
      - ./db/GeoLite2-ASN.mmdb:/srv/GeoLite2-ASN.mmdb
      - ./db/GeoLite2-City.mmdb:/srv/GeoLite2-City.mmdb
    ports: 
      - 8080:8080
    



  # mongodb-connector

  # flaskp-api-connector

  # dispatcher-connector

  # flask-display-connector

volumes: 
  crowdsec-config:
  crowdsec-db: